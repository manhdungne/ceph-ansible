---
- name: Configure Ceph RGW Multisite Sync Policy
  hosts: rgw_sync_policy_host
  become: true
  gather_facts: false

  vars:
    # Định danh của sync group
    sync_group_id: "{{ sync_group_id | default('default-sync-group') }}"
    # Trạng thái của sync group: allowed, enabled, forbidden
    sync_group_status: "{{ sync_group_status | default('enabled') }}"

    # Danh sách các flow cần tạo
    sync_flows: "{{ sync_flows | default([]) }}"

    # Cấu hình pipe
    sync_pipe:
      pipe_id: "{{ sync_pipe_id | default('default-pipe') }}"
      source_zones: "{{ sync_pipe_source_zones | default('*') }}"
      source_bucket: "{{ sync_pipe_source_bucket | default('*') }}"
      dest_zones: "{{ sync_pipe_dest_zones | default('*') }}"
      dest_bucket: "{{ sync_pipe_dest_bucket | default('*') }}"

  tasks:
    - name: Create sync group
      command: >
        radosgw-admin sync group create
        --group-id={{ sync_group_id }}
        --status=allowed
      register: create_group_result
      failed_when: false
      changed_when: "'group-id' in create_group_result.stdout"

    - name: Create symmetrical flows
      when: item.flow_type == "symmetrical"
      loop: "{{ sync_flows }}"
      loop_control:
        label: "{{ item.flow_id }}"
      command: >
        radosgw-admin sync group flow create
        --group-id={{ sync_group_id }}
        --flow-id={{ item.flow_id }}
        --flow-type=symmetrical
        --zones={{ item.zones | join(',') }}

    - name: Create directional flows
      when: item.flow_type == "directional"
      loop: "{{ sync_flows }}"
      loop_control:
        label: "{{ item.flow_id }}"
      command: >
        radosgw-admin sync group flow create
        --group-id={{ sync_group_id }}
        --flow-id={{ item.flow_id }}
        --flow-type=directional
        --source-zone={{ item.source_zone }}
        --dest-zone={{ item.dest_zone }}


    - name: Create sync pipe
      command: >
        radosgw-admin sync group pipe create
        --group-id={{ sync_group_id }}
        --pipe-id={{ sync_pipe.pipe_id }}
        --source-zones='{{ sync_pipe.source_zones }}'
        --source-bucket='{{ sync_pipe.source_bucket }}'
        --dest-zones='{{ sync_pipe.dest_zones }}'
        --dest-bucket='{{ sync_pipe.dest_bucket }}'

    - name: Enable sync group
      command: >
        radosgw-admin sync group modify
        --group-id={{ sync_group_id }}
        --status={{ sync_group_status }}

    - name: Commit sync policy changes
      command: radosgw-admin period update --commit
